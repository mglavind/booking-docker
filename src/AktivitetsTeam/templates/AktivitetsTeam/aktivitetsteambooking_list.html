{% extends "base.html" %}
{% load static %}
{% load bootstrap_icons %}

{% block title %}Aktivitetsplan{% endblock %}

{% block extra_css %}
<style>
    /* 1. Layout & Wrapper */
    .container-fluid { padding-left: 2rem; padding-right: 2rem; }
    
    .timeline-wrapper {
        display: flex;
        overflow-x: auto;
        border: 1px solid #dee2e6;
        border-radius: 12px;
        background: white;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        margin-bottom: 2rem;
    }

    /* 2. Sidebar (Resource Names) */
    .timeline-sidebar {
        width: 180px;
        flex-shrink: 0;
        background: #f8f9fa;
        border-right: 2px solid #dee2e6;
        position: sticky;
        left: 0;
        z-index: 10;
    }

    .row-item-name {
        height: calc(var(--num-levels, 1) * 50px);
        min-height: 50px;
        padding: 0 15px;
        font-weight: 600;
        border-bottom: 1px solid #dee2e6;
        display: flex;
        align-items: center;
        background: #f8f9fa;
        font-size: 0.85rem;
    }

    /* 3. Main Content & Grid */
    .timeline-content {
        position: relative;
        background: white;
        min-width: fit-content;
    }

    .timeline-header {
        display: flex;
        border-bottom: 2px solid #dee2e6;
        height: 60px;
        background: #f8f9fa;
    }

    .hour-col {
        flex-shrink: 0;
        width: {{ hour_width }}px;
        border-right: 1px solid #eee;
        text-align: center;
        font-size: 11px;
        padding-top: 10px;
        color: #6c757d;
    }

    .hour-col.new-day {
        border-left: 2px solid #212529;
        background-color: #f1f3f5;
        color: #212529;
    }

    /* THE GRID LINES */
    .timeline-row {
        position: relative;
        height: calc(var(--num-levels, 1) * 50px);
        min-height: 50px;
        border-bottom: 1px solid #eee;
        /* This draws the vertical lines */
        background-image: linear-gradient(to right, #f1f3f5 1px, transparent 1px);
        background-size: {{ hour_width }}px 100%;
        cursor: crosshair;
    }

    /* 4. Booking Boxes */
    .booking-box {
        position: absolute;
        top: calc(var(--level, 0) * 50px + 8px);
        height: 34px;
        border-radius: 6px;
        z-index: 5;
        padding: 5px 10px;
        color: white;
        font-size: 11px;
        font-weight: 600;
        overflow: hidden;
        white-space: nowrap;
        text-overflow: ellipsis;
        border: 1px solid rgba(0,0,0,0.1);
    }

    .status-approved { background-color: #198754; }
    .status-pending { background-color: #f59e0b; color: #212529; }
    
    /* Selection Bar (Ghost Box) */
    .status-new { 
        background-color: var(--bs-primary) !important; 
        color: white;
        border: 2px solid white;
        z-index: 100 !important;
        box-shadow: 0 0 15px rgba(13, 110, 253, 0.4);
        opacity: 0.9;
    }

    /* 5. Floating Controls */
    #timeline-controls {
        position: fixed;
        bottom: 30px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 2000;
        display: none; /* Shown by JS */
        background: white;
        padding: 12px 24px;
        border-radius: 50px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.25);
        border: 1px solid #dee2e6;
        align-items: center;
        gap: 15px;
    }

    .day-label-text {
        font-size: 10px;
        font-weight: bold;
        display: block;
        text-transform: uppercase;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="display-5 mb-0">Aktivitetsplan</h1>
            <p class="text-muted">Klik og tr√¶k i tidsplanen for at oprette en ny booking</p>
        </div>
        <a href="{% url 'AktivitetsTeam_AktivitetsTeamBooking_create' %}" class="btn btn-outline-primary rounded-pill px-4">
            {% bs_icon "plus-lg" %} Manuel oprettelse
        </a>
    </div>

    <div class="timeline-wrapper">
        <div class="timeline-sidebar">
            <div style="height: 60px; border-bottom: 2px solid #dee2e6; background: #f8f9fa;"></div>
            {% for row in item_rows %}
                <div class="row-item-name" style="--num-levels: {{ row.num_levels }};">
                    {{ row.name }}
                </div>
            {% endfor %}
        </div>

        <div class="timeline-content">
            <div class="timeline-header">
                {% for h in hours_list %}
                    <div class="hour-col {% if h.is_new_day %}new-day{% endif %}">
                        {% if h.is_new_day %}
                            <span class="day-label-text">{{ h.day_label|date:"D j/m" }}</span>
                        {% else %}
                            {{ h.label }}
                        {% endif %}
                        
                    </div>
                {% endfor %}
            </div>

            {% for row in item_rows %}
                <div class="timeline-row" data-item-id="{{ row.id }}" style="--num-levels: {{ row.num_levels }};">
                    {% for b in row.bookings %}
                        <div class="booking-box status-{{ b.status|lower }}" 
                             style="--level: {{ b.level }}; left: calc({{ b.left_val }} * {{ hour_width }}px); width: calc({{ b.width_val }} * {{ hour_width }}px);"
                             data-bs-toggle="tooltip" data-bs-html="true" title="{{ b.hover_content|safe }}"
                             onclick="location.href='{% url 'AktivitetsTeam_AktivitetsTeamBooking_detail' pk=b.id %}'">
                            <span class="px-1">{{ b.team_name }}</span>
                        </div>
                    {% endfor %}
                </div>
            {% endfor %}
        </div>
    </div>
</div>

<div id="timeline-controls">
    <div id="selection-summary" class="fw-bold text-primary border-end pe-3">
        00:00 - 00:00
    </div>
    <button id="cancel-selection" class="btn btn-light rounded-pill px-3 btn-sm">
        {% bs_icon "x-lg" %} Annuller
    </button>
    <button id="confirm-selection" class="btn btn-primary rounded-pill px-4 btn-sm shadow-sm">
        {% bs_icon "check2-circle" %} Opret Booking
    </button>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    // 1. Tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    tooltipTriggerList.map(function (el) { return new bootstrap.Tooltip(el) });

    // 2. Variables
    const hourWidth = parseInt("{{ hour_width }}") || 40;
    const timelineStart = new Date("{{ timeline_start_iso|safe }}");
    const controls = document.getElementById('timeline-controls');
    const summary = document.getElementById('selection-summary');
    const confirmBtn = document.getElementById('confirm-selection');
    const cancelBtn = document.getElementById('cancel-selection');
    const rows = document.querySelectorAll('.timeline-row');

    let isDrawing = false;
    let startX = 0;
    let ghostBox = null;
    let selectionData = null;

    const pad = (n) => String(n).padStart(2, '0');

    function resetSelection() {
        if (ghostBox) ghostBox.remove();
        ghostBox = null;
        isDrawing = false;
        controls.style.display = 'none';
        selectionData = null;
    }

    // 3. Drawing Logic
    rows.forEach(row => {
        row.addEventListener('mousedown', function(e) {
            if (e.target.closest('.booking-box')) return; // Don't draw over existing bookings
            resetSelection();

            isDrawing = true;
            const rect = this.getBoundingClientRect();
            startX = e.clientX - rect.left;

            ghostBox = document.createElement('div');
            ghostBox.className = 'booking-box status-new';
            ghostBox.style.left = startX + 'px';
            ghostBox.style.width = '0px';
            ghostBox.style.pointerEvents = 'none'; // Allow mouseup on the row
            ghostBox.dataset.itemId = this.getAttribute('data-item-id');
            
            this.appendChild(ghostBox);
        });
    });

    window.addEventListener('mousemove', function(e) {
        if (!isDrawing || !ghostBox) return;
        const rect = ghostBox.parentElement.getBoundingClientRect();
        let width = (e.clientX - rect.left) - startX;
        
        if (width > 0) {
            // Visual snap to 30 min increments
            const snap = hourWidth / 2;
            ghostBox.style.width = Math.max(snap, Math.round(width / snap) * snap) + 'px';
        }
    });

    window.addEventListener('mouseup', function() {
        if (!isDrawing || !ghostBox) return;
        isDrawing = false;

        const finalWidth = parseInt(ghostBox.style.width);
        if (finalWidth > 15) {
            const startHours = startX / hourWidth;
            const durationHours = finalWidth / hourWidth;

            let s = new Date(timelineStart.getTime() + startHours * 3600000);
            let e = new Date(s.getTime() + durationHours * 3600000);

            // Final snap to 30 mins for the data
            const round = (d) => new Date(Math.round(d.getTime() / 1800000) * 1800000);
            s = round(s); e = round(e);

            const sTime = `${pad(s.getHours())}:${pad(s.getMinutes())}`;
            const eTime = `${pad(e.getHours())}:${pad(e.getMinutes())}`;

            summary.innerText = `${sTime} - ${eTime}`;
            ghostBox.innerHTML = `<span class="px-1 small">${sTime} - ${eTime}</span>`;

            selectionData = {
                item: ghostBox.dataset.itemId,
                start_date: `${s.getFullYear()}-${pad(s.getMonth()+1)}-${pad(s.getDate())}`,
                start_time: sTime,
                end_date: `${e.getFullYear()}-${pad(e.getMonth()+1)}-${pad(e.getDate())}`,
                end_time: eTime
            };
            controls.style.display = 'flex';
        } else {
            resetSelection();
        }
    });

    // 4. Buttons Logic
    cancelBtn.addEventListener('click', resetSelection);

    confirmBtn.addEventListener('click', function() {
        if (!selectionData) return;
        const baseUrl = "{% url 'AktivitetsTeam_AktivitetsTeamBooking_create' %}";
        const params = new URLSearchParams(selectionData).toString();
        window.location.href = `${baseUrl}?${params}`;
    });
});
</script>
{% endblock %}