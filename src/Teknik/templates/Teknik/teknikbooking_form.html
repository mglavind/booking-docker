{% extends "base.html" %}
{% load static %}
{% load django_bootstrap5 %}
{% load l10n %}

{# Keeping styles and links outside the block as per your working setup #}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
<style>
    /* Force the map height and visibility */
    .map-container { 
        border-radius: 1rem; 
        overflow: hidden; 
        border: 1px solid #dee2e6;
        margin-bottom: 1.5rem;
        height: 400px !important; 
        min-height: 400px !important;
    }

    /* Target the specific classes generated by LocationField and Leaflet */
    .location-map, 
    .map_location-map, 
    .leaflet-container { 
        height: 400px !important; 
        min-height: 400px !important;
        width: 100% !important; 
        display: block !important;
    }

    .breadcrumb-item + .breadcrumb-item::before { content: "›"; font-size: 1.2rem; vertical-align: middle; }
</style>

{% block content %}
{# CRITICAL: This loads the necessary JS/CSS for the LocationField map to exist #}
{{ form.media }}

<div class="container py-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb bg-light p-3 rounded-pill shadow-sm px-4">
            <li class="breadcrumb-item"><a href="{% url 'index' %}" class="text-decoration-none text-muted">Hjem</a></li>
            <li class="breadcrumb-item"><a href="{% url 'Teknik_TeknikBooking_list' %}" class="text-decoration-none text-muted">Teknik bestillinger</a></li>
            <li class="breadcrumb-item active fw-bold text-secondary" aria-current="page">
                {% if object %}Rediger{% else %}Ny{% endif %} booking
            </li>
        </ol>
    </nav>

    <div class="mb-4 mt-2">
        <h1 class="display-5 fw-bold">{% if object %}Rediger{% else %}Ny{% endif %} Teknik booking</h1>
        {% if user.is_authenticated and user.events.first %}
        <div class="alert alert-light border shadow-sm rounded-4" role="alert">
            <bs_icon class="bi bi-clock-history me-2 text-danger"></bs_icon>
            Deadline for Teknik bestillinger: 
            <span class="badge bg-danger rounded-pill">{{ user.events.first.deadline_teknik }}</span>
        </div>
        {% endif %}
    </div>

    <div class="card shadow-sm border-0 rounded-4 overflow-hidden">
        <div class="card-body p-4 p-md-5">
            <form id="form" role="form" method="post" class="needs-validation">
                {% csrf_token %}
                {% bootstrap_form_errors form type='non_fields' %}

                <h5 class="fw-bold border-bottom pb-2 mb-3 mt-3">
                    <bs_icon class="bi bi-info-circle me-2"></bs_icon>Information
                </h5>
                <div class="row">
                    <div class="col-md-8 mb-3">{% bootstrap_field form.item %}</div>
                    <div class="col-md-4 mb-3">{% bootstrap_field form.quantity %}</div>
                    <div class="col-md-6 mb-3">{% bootstrap_field form.team %}</div>
                    <div class="col-md-6 mb-3">{% bootstrap_field form.team_contact %}</div>
                </div>

                <h5 class="fw-bold border-bottom pb-2 mb-3 mt-4">
                    <bs_icon class="bi bi-calendar-event me-2"></bs_icon>Tidsperiode
                </h5>
                <div class="row">
                    <div class="col-md-3 mb-3">{% bootstrap_field form.start_date %}</div>
                    <div class="col-md-3 mb-3">{% bootstrap_field form.start_time %}</div>
                    <div class="col-md-3 mb-3">{% bootstrap_field form.end_date %}</div>
                    <div class="col-md-3 mb-3">{% bootstrap_field form.end_time %}</div>
                </div>

                <h5 class="fw-bold border-bottom pb-2 mb-3 mt-4">
                    <bs_icon class="bi bi-chat-left-text me-2"></bs_icon>Behov & Bemærkninger
                </h5>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <div class="p-3 border rounded-4 bg-light">
                            {% bootstrap_field form.assistance_needed %}
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <div class="p-3 border rounded-4 bg-light">
                            {% bootstrap_field form.delivery_needed %}
                        </div>
                    </div>
                    <div class="col-12 mb-3">
                        {% bootstrap_field form.remarks %}
                    </div>
                </div>

                <h5 class="fw-bold border-bottom pb-2 mb-3 mt-4">
                    <bs_icon class="bi bi-geo-alt me-2"></bs_icon>Lokation
                </h5>
                <div class="row">
                    <div class="col-12 mb-4">
                        <label class="form-label fw-bold small text-uppercase">Vælg placering på kortet</label>
                        <div class="map-container">
                            {# This field will now correctly turn into a map thanks to form.media #}
                            {% bootstrap_field form.location show_label=False %}
                        </div>
                        <small class="text-muted">Klik på kortet eller træk i markøren for at angive placeringen.</small>
                    </div>
                </div>

                <div class="d-grid gap-2 d-md-flex justify-content-md-start mb-3">
                    <button type="submit" class="btn btn-primary btn-lg px-5 rounded-pill shadow-sm">
                        <bs_icon class="bi bi-send me-2"></bs_icon>Indsend booking
                    </button>
                    <a href="{% url 'Teknik_TeknikBooking_list' %}" class="btn btn-outline-secondary btn-lg rounded-pill">Annuller</a>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    window.addEventListener('load', function() {
        // Slightly longer delay to ensure LocationField scripts have finished building the map
        setTimeout(function() {
            window.dispatchEvent(new Event('resize'));
            
            // Handle the specific map instance if it exists
            if (window.map_location) {
                window.map_location.invalidateSize();
            }
            
            // Generic Leaflet fix for all containers found
            if (typeof L !== 'undefined') {
                var maps = document.querySelectorAll('.leaflet-container');
                maps.forEach(function(m) {
                    if (m._leaflet_map) {
                        m._leaflet_map.invalidateSize();
                    }
                });
            }
        }, 500);
    });
</script>
{% endblock %}